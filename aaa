-- ============================================================
-- TWOCANDO & ARTFUL SEMI TP v1.2 - FIXED (WITH KEYBIND SELECTION)
-- ============================================================

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local TweenService = game:GetService("TweenService")
local CoreGui = game:GetService("CoreGui")
local Workspace = game:GetService("Workspace")
local Lighting = game:GetService("Lighting")
local HttpService = game:GetService("HttpService")
local ProximityPromptService = game:GetService("ProximityPromptService")
local VirtualInputManager = game:GetService("VirtualInputManager")
local ContextActionService = game:GetService("ContextActionService")

local LocalPlayer = Players.LocalPlayer
local Camera = Workspace.CurrentCamera

-- ============================================================
-- AUTO STEAL CONFIGURATION (Always ON)
-- ============================================================
local autoStealEnabled = false
local stealRadius = 30

-- SERVICES & MODULES
local Packages = ReplicatedStorage:WaitForChild("Packages")
local Datas = ReplicatedStorage:WaitForChild("Datas")
local Shared = ReplicatedStorage:WaitForChild("Shared")
local Utils = ReplicatedStorage:WaitForChild("Utils")

local Synchronizer = require(Packages:WaitForChild("Synchronizer"))
local AnimalsData = require(Datas:WaitForChild("Animals"))
local AnimalsShared = require(Shared:WaitForChild("Animals"))
local NumberUtils = require(Utils:WaitForChild("NumberUtils"))

-- GLOBAL STATE
local allAnimalsCache = {}
local InternalStealCache = {}
local PromptMemoryCache = {}
local nearbyAnimalsCache = {}

-- Steal progress tracking
local isStealing = false
local stealProgress = 0
local stealDuration = 1.42
local currentTarget = nil

-- ============================================================
-- KEYBIND SYSTEM - FIXED VERSION
-- ============================================================
local toggleKeybind = Enum.KeyCode.F
local isListeningForKey = false
local keybindButton = nil
local keybindLabel = nil
local ClickSound = nil

-- Blocked keys
local blockedKeys = {
    [Enum.KeyCode.W] = true,
    [Enum.KeyCode.A] = true,
    [Enum.KeyCode.S] = true,
    [Enum.KeyCode.D] = true,
    [Enum.KeyCode.Up] = true,
    [Enum.KeyCode.Down] = true,
    [Enum.KeyCode.Left] = true,
    [Enum.KeyCode.Right] = true,
    [Enum.KeyCode.Space] = true,
    [Enum.KeyCode.LeftShift] = true,
    [Enum.KeyCode.RightShift] = true,
    [Enum.KeyCode.LeftControl] = true,
    [Enum.KeyCode.RightControl] = true,
    [Enum.KeyCode.LeftAlt] = true,
    [Enum.KeyCode.RightAlt] = true,
    [Enum.KeyCode.Tab] = true,
    [Enum.KeyCode.Escape] = true,
    [Enum.KeyCode.Return] = true,
    [Enum.KeyCode.Backspace] = true,
}

-- Forward declarations
local updateUI
local CurrentConfig
local saveConfig

local function updateKeybindDisplay()
    if keybindLabel then
        local keyName = tostring(toggleKeybind):gsub("Enum.KeyCode.", "")
        keybindLabel.Text = keyName
    end
end

local function bindToggleAction()
    pcall(function()
        ContextActionService:UnbindAction("ToggleTeleport")
        ContextActionService:BindAction("ToggleTeleport", function(actionName, inputState, inputObject)
            if inputState == Enum.UserInputState.Begin then
                if not isStealing then
                    autoStealEnabled = not autoStealEnabled
                    if updateUI then
                        updateUI(autoStealEnabled)
                    end
                    if ClickSound then
                        pcall(function() ClickSound:Play() end)
                    end
                end
            end
        end, false, toggleKeybind)
    end)
end

local function setKeybind(newKey)
    if newKey and newKey ~= Enum.KeyCode.Unknown then
        toggleKeybind = newKey
        updateKeybindDisplay()
        if CurrentConfig then
            CurrentConfig.Keybind = tostring(newKey):gsub("Enum.KeyCode.", "")
            if saveConfig then saveConfig() end
        end
        bindToggleAction()
        return true
    end
    return false
end

local function startKeyListening()
    isListeningForKey = true
    if keybindButton then
        keybindButton.Text = "Press any key..."
        keybindButton.BackgroundColor3 = Color3.fromRGB(180, 0, 255)
    end
end

local function stopKeyListening()
    isListeningForKey = false
    if keybindButton then
        keybindButton.Text = "SET KEYBIND"
        keybindButton.BackgroundColor3 = Color3.fromRGB(60, 60, 65)
    end
end

-- ============================================================
-- GUI CONSTANTS & CONFIG
-- ============================================================
local ScriptVersion = "Twocando & Artful Semi TP v1.2"
local ConfigFile = "twocando_artful_semitp_config.json"

local ViewportSize = Camera.ViewportSize
local IsMobile = ViewportSize.X < 800
local HeaderBtnSize = IsMobile and 24 or 34

local function randomString(length)
    local chars = "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789"
    local str = ""
    for i = 1, length do
        local rand = math.random(1, #chars)
        str = str .. string.sub(chars, rand, rand)
    end
    return str
end

local DefaultConfig = {
    X = {Scale = 0.5, Offset = 0},
    Y = {Scale = 0.5, Offset = 0},
    Size = IsMobile and {Width = 260, Height = 350} or {Width = 380, Height = 450},
    Settings = {
        AutoResetOnStart = true,
        AutoBigPotion = true,
        AutoWalk = true,
    },
    StealRadius = 30,
    WalkSpeed = 28.95,
    Keybind = "F",
    Colors = {
        Background = {15, 0, 25},
        Outline = {180, 0, 255},
        Rainbow = false,
        RainbowSpeed = 0.5,
    }
}

CurrentConfig = {}

for k, v in pairs(DefaultConfig) do
    if type(v) == "table" then
        CurrentConfig[k] = {}
        for k2, v2 in pairs(v) do
            if type(v2) == "table" then
                CurrentConfig[k][k2] = {}
                for k3, v3 in pairs(v2) do
                    CurrentConfig[k][k2][k3] = v3
                end
            else
                CurrentConfig[k][k2] = v2
            end
        end
    else
        CurrentConfig[k] = v
    end
end

local Toggles = {}
local MainFrame, MainGradient, Header, ButtonsContainer
local SettingsFrame, ColorFrame, AdvancedFrame
local StatusLabel, NearbyCountLabel, ProgressFill, ProgressPercent
local DesyncResetButton, PotionStatusLabel
local ProgressContainer

saveConfig = function()
    if writefile then
        pcall(function()
            CurrentConfig.Keybind = tostring(toggleKeybind):gsub("Enum.KeyCode.", "")
            writefile(ConfigFile, HttpService:JSONEncode(CurrentConfig))
        end)
    end
end

local function loadConfig()
    if isfile and readfile and isfile(ConfigFile) then
        pcall(function()
            local data = HttpService:JSONDecode(readfile(ConfigFile))
            if data then
                if data.Settings then
                    for k, v in pairs(data.Settings) do
                        CurrentConfig.Settings[k] = v
                    end
                end
                if data.Colors then
                    for k, v in pairs(data.Colors) do
                        CurrentConfig.Colors[k] = v
                    end
                end
                if data.Size then CurrentConfig.Size = data.Size end
                if data.StealRadius then CurrentConfig.StealRadius = data.StealRadius end
                if data.WalkSpeed then CurrentConfig.WalkSpeed = data.WalkSpeed end
                if data.Keybind then
                    local keyCode = Enum.KeyCode[data.Keybind]
                    if keyCode then toggleKeybind = keyCode end
                end
            end
        end)
    end
    stealRadius = CurrentConfig.StealRadius or 30
end
loadConfig()
-- ============================================================
-- AUTO WALK SYSTEM
-- ============================================================
local isAutoWalking = false
local animalGrabbed = false
local selectedBase = "right"

local function getDeliveryHitbox()
    local plots = workspace:FindFirstChild("Plots")
    if not plots then return nil end
    for _, plot in ipairs(plots:GetChildren()) do
        local sign = plot:FindFirstChild("PlotSign")
        local hitbox = plot:FindFirstChild("DeliveryHitbox")
        if sign and sign:FindFirstChild("YourBase") and sign.YourBase.Enabled and hitbox then
            return hitbox
        end
    end
    return nil
end

local function stopAutoWalk()
    local char = LocalPlayer.Character
    if char then
        local hum = char:FindFirstChildOfClass("Humanoid")
        if hum then hum:MoveTo(Vector3.new(0, 0, 0)) end
    end
    isAutoWalking = false
    animalGrabbed = false
end

local function optimizedAutoWalkWithOpposite(selBase)
    if not CurrentConfig.Settings.AutoWalk then return end
    if not animalGrabbed then
        task.wait(0.5)
        if not animalGrabbed then return end
    end
    stopAutoWalk()
    
    local char = LocalPlayer.Character
    if not char then return end
    local hrp = char:FindFirstChild("HumanoidRootPart")
    local hum = char:FindFirstChildOfClass("Humanoid")
    if not hrp or not hum then return end
    
    local originalWalkSpeed = hum.WalkSpeed
    isAutoWalking = true
    
    local targetPos
    if selBase == "right" then
        targetPos = Vector3.new(-348.18, -6.54, 6.36)
    else
        targetPos = Vector3.new(-347.51, -6.60, 113.66)
    end
    
    task.delay(0.1, function()
        if isAutoWalking and hrp and hrp.Parent then
            local speed = CurrentConfig.WalkSpeed or 28.95
            local direction = (targetPos - hrp.Position).Unit
            hrp.AssemblyLinearVelocity = Vector3.new(direction.X * speed, hrp.AssemblyLinearVelocity.Y, direction.Z * speed)
        end
    end)
    
    hum:MoveTo(targetPos)
    
    task.spawn(function()
        local startTime = tick()
        local maxTime = 20
        local speedBoostActive = false
        
        while isAutoWalking and tick() - startTime < maxTime do
            if not LocalPlayer.Character or not hrp or not hrp.Parent then
                stopAutoWalk()
                return
            end
            
            local playerPos = hrp.Position
            local dist = (Vector3.new(playerPos.X, 0, playerPos.Z) - Vector3.new(targetPos.X, 0, targetPos.Z)).Magnitude
            
            local deliveryHitbox = getDeliveryHitbox()
            local nearDelivery = false
            if deliveryHitbox then
                if (playerPos - deliveryHitbox.Position).Magnitude <= 20 then
                    nearDelivery = true
                end
            end
            
            if not nearDelivery and tick() - startTime > 0.1 then
                local speed = CurrentConfig.WalkSpeed or 28.95
                local direction = (targetPos - playerPos)
                if direction.Magnitude > 1 then
                    direction = direction.Unit
                    hrp.AssemblyLinearVelocity = Vector3.new(direction.X * speed, hrp.AssemblyLinearVelocity.Y, direction.Z * speed)
                    speedBoostActive = true
                end
            else
                if speedBoostActive then
                    hrp.AssemblyLinearVelocity = Vector3.new(0, hrp.AssemblyLinearVelocity.Y, 0)
                    speedBoostActive = false
                end
            end
            
            hum:MoveTo(targetPos)
            
            if dist <= 3 then
                hrp.AssemblyLinearVelocity = Vector3.new(0, hrp.AssemblyLinearVelocity.Y, 0)
                hum.WalkSpeed = originalWalkSpeed
                hum:MoveTo(hrp.Position)
                stopAutoWalk()
                return
            end
            
            task.wait(0.05)
        end
        
        if hrp and hrp.Parent then
            hrp.AssemblyLinearVelocity = Vector3.new(0, hrp.AssemblyLinearVelocity.Y, 0)
        end
        hum.WalkSpeed = originalWalkSpeed
        stopAutoWalk()
    end)
end

-- ============================================================
-- BIG POTION SYSTEM
-- ============================================================
local POTION_NAME = "Giant Potion"
local potionTool = nil

local function tryEquipPotion()
    local char = LocalPlayer.Character
    if not char then return false end
    if potionTool and potionTool.Parent == char then return true end
    
    local backpack = LocalPlayer:FindFirstChild("Backpack")
    local found = nil
    if backpack then found = backpack:FindFirstChild(POTION_NAME) end
    if not found and char then found = char:FindFirstChild(POTION_NAME) end
    
    if found then
        potionTool = found
        local hum = char:FindFirstChildOfClass("Humanoid")
        if hum then
            hum:EquipTool(potionTool)
            task.wait(0.06)
            return true
        end
    end
    return false
end

local function tryDrinkPotion()
    if not potionTool then return end
    local char = LocalPlayer.Character
    if not char then return end
    if potionTool.Parent ~= char then return end
    
    pcall(function()
        VirtualInputManager:SendMouseButtonEvent(0, 0, 0, true, game, 0)
        task.wait(0.04)
        VirtualInputManager:SendMouseButtonEvent(0, 0, 0, false, game, 0)
    end)
    
    pcall(function()
        if keypress then
            keypress(0x01)
            task.wait(0.04)
            keyrelease(0x01)
        end
    end)
end

local function unequipAllTools()
    local char = LocalPlayer.Character
    if char then
        local hum = char:FindFirstChildOfClass("Humanoid")
        if hum then hum:UnequipTools() end
    end
end

local function equipCarpet()
    local char = LocalPlayer.Character
    if not char then return false end
    local hum = char:FindFirstChildOfClass("Humanoid")
    if not hum then return false end
    local backpack = LocalPlayer:FindFirstChild("Backpack")
    if backpack then
        local carpet = backpack:FindFirstChild("Flying Carpet")
        if carpet then hum:EquipTool(carpet) return true end
    end
    return char:FindFirstChild("Flying Carpet") ~= nil
end

local function useGiantPotion()
    if not CurrentConfig.Settings.AutoBigPotion then return false end
    if tryEquipPotion() then
        task.wait(0.05)
        tryDrinkPotion()
        task.wait(0.1)
        unequipAllTools()
        task.wait(0.05)
        equipCarpet()
        return true
    end
    return false
end

-- ============================================================
-- DESYNC SYSTEM
-- ============================================================
local desyncEnabled = false

local function setFFlag(name, value)
    pcall(function() setfflag(name, tostring(value)) end)
end

local function applyDesync()
    local FFlags = {
        GameNetPVHeaderRotationalVelocityZeroCutoffExponent = -5000,
        LargeReplicatorWrite5 = true,
        LargeReplicatorEnabled9 = true,
        AngularVelociryLimit = 360,
        TimestepArbiterVelocityCriteriaThresholdTwoDt = 2147483646,
        S2PhysicsSenderRate = 15000,
        DisableDPIScale = true,
        MaxDataPacketPerSend = 2147483647,
        PhysicsSenderMaxBandwidthBps = 20000,
        TimestepArbiterHumanoidLinearVelThreshold = 21,
        MaxMissedWorldStepsRemembered = -2147483648,
        PlayerHumanoidPropertyUpdateRestrict = true,
        SimDefaultHumanoidTimestepMultiplier = 0,
        StreamJobNOUVolumeLengthCap = 2147483647,
        DebugSendDistInSteps = -2147483648,
        GameNetDontSendRedundantNumTimes = 1,
        CheckPVLinearVelocityIntegrateVsDeltaPositionThresholdPercent = 1,
        CheckPVDifferencesForInterpolationMinVelThresholdStudsPerSecHundredth = 1,
        LargeReplicatorSerializeRead3 = true,
        ReplicationFocusNouExtentsSizeCutoffForPauseStuds = 2147483647,
        CheckPVCachedVelThresholdPercent = 10,
        CheckPVDifferencesForInterpolationMinRotVelThresholdRadsPerSecHundredth = 1,
        GameNetDontSendRedundantDeltaPositionMillionth = 1,
        InterpolationFrameVelocityThresholdMillionth = 5,
        StreamJobNOUVolumeCap = 2147483647,
        InterpolationFrameRotVelocityThresholdMillionth = 5,
        CheckPVCachedRotVelThresholdPercent = 10,
        WorldStepMax = 30,
        InterpolationFramePositionThresholdMillionth = 5,
        TimestepArbiterHumanoidTurningVelThreshold = 1,
        SimOwnedNOUCountThresholdMillionth = 2147483647,
        GameNetPVHeaderLinearVelocityZeroCutoffExponent = -5000,
        NextGenReplicatorEnabledWrite4 = true,
        TimestepArbiterOmegaThou = 1073741823,
        MaxAcceptableUpdateDelay = 1,
        LargeReplicatorSerializeWrite4 = true
    }
    for name, value in pairs(FFlags) do
        setFFlag(tostring(name), tostring(value))
    end
    desyncEnabled = true
end

local function resetDesync()
    applyDesync()
    local char = LocalPlayer.Character
    if char then
        local hum = char:FindFirstChildWhichIsA('Humanoid')
        if hum then hum:ChangeState(Enum.HumanoidStateType.Dead) end
        char:ClearAllChildren()
        local newChar = Instance.new('Model')
        newChar.Parent = workspace
        LocalPlayer.Character = newChar
        task.wait()
        LocalPlayer.Character = char
        newChar:Destroy()
    end
    desyncEnabled = true
end
-- ============================================================
-- HELPER FUNCTIONS (AUTO STEAL CORE)
-- ============================================================
local function isMyBaseAnimal(animalData)
    if not animalData or not animalData.plot then return false end
    local plots = workspace:FindFirstChild("Plots")
    if not plots then return false end
    local plot = plots:FindFirstChild(animalData.plot)
    if not plot then return false end
    
    local channel = Synchronizer:Get(plot.Name)
    if channel then
        local owner = channel:Get("Owner")
        if owner then
            if typeof(owner) == "Instance" and owner:IsA("Player") then
                return owner.UserId == LocalPlayer.UserId
            elseif typeof(owner) == "table" and owner.UserId then
                return owner.UserId == LocalPlayer.UserId
            elseif typeof(owner) == "Instance" then
                return owner == LocalPlayer
            end
        end
    end
    
    local sign = plot:FindFirstChild("PlotSign")
    if sign then
        local yourBase = sign:FindFirstChild("YourBase")
        if yourBase and yourBase:IsA("BillboardGui") then
            return yourBase.Enabled == true
        end
    end
    return false
end

local function getAnimalPosition(animalData)
    local plot = workspace.Plots:FindFirstChild(animalData.plot)
    if not plot then return nil end
    local podiums = plot:FindFirstChild("AnimalPodiums")
    if not podiums then return nil end
    local podium = podiums:FindFirstChild(animalData.slot)
    if not podium then return nil end
    return podium:GetPivot().Position
end

local function getHRP()
    local char = LocalPlayer.Character
    if not char then return end
    return char:FindFirstChild("HumanoidRootPart") or char:FindFirstChild("UpperTorso")
end

local function getAnimalsInRadius()
    local hrp = getHRP()
    if not hrp then return {} end
    local playerPosition = hrp.Position
    local animalsInRadius = {}
    
    for _, animalData in ipairs(allAnimalsCache) do
        if not isMyBaseAnimal(animalData) then
            local animalPos = getAnimalPosition(animalData)
            if animalPos then
                local distance = (animalPos - playerPosition).Magnitude
                if distance <= stealRadius then
                    table.insert(animalsInRadius, {
                        animalData = animalData,
                        distance = distance,
                        mpsValue = animalData.genValue,
                        petName = animalData.name,
                        mpsText = animalData.genText,
                        owner = animalData.owner,
                        plot = animalData.plot,
                        slot = animalData.slot,
                        uid = animalData.uid
                    })
                end
            end
        end
    end
    
    table.sort(animalsInRadius, function(a, b) return a.distance < b.distance end)
    nearbyAnimalsCache = animalsInRadius
    return animalsInRadius
end

local function get_nearest_animal_in_radius()
    local animalsInRadius = getAnimalsInRadius()
    if #animalsInRadius > 0 then return animalsInRadius[1] end
    return nil
end

local function findProximityPromptForAnimal(animalData)
    if not animalData then return nil end
    local cachedPrompt = PromptMemoryCache[animalData.uid]
    if cachedPrompt and cachedPrompt.Parent then return cachedPrompt end
    
    local plot = workspace.Plots:FindFirstChild(animalData.plot)
    if not plot then return nil end
    local podiums = plot:FindFirstChild("AnimalPodiums")
    if not podiums then return nil end
    local podium = podiums:FindFirstChild(animalData.slot)
    if not podium then return nil end
    local base = podium:FindFirstChild("Base")
    if not base then return nil end
    local spawn = base:FindFirstChild("Spawn")
    if not spawn then return nil end
    local attach = spawn:FindFirstChild("PromptAttachment")
    if not attach then return nil end
    
    for _, p in ipairs(attach:GetChildren()) do
        if p:IsA("ProximityPrompt") then
            PromptMemoryCache[animalData.uid] = p
            return p
        end
    end
    return nil
end

local function buildStealCallbacks(prompt)
    if InternalStealCache[prompt] then return end
    local data = {holdCallbacks = {}, triggerCallbacks = {}, ready = true}
    
    local ok1, conns1 = pcall(getconnections, prompt.PromptButtonHoldBegan)
    if ok1 and type(conns1) == "table" then
        for _, conn in ipairs(conns1) do
            if type(conn.Function) == "function" then
                table.insert(data.holdCallbacks, conn.Function)
            end
        end
    end
    
    local ok2, conns2 = pcall(getconnections, prompt.Triggered)
    if ok2 and type(conns2) == "table" then
        for _, conn in ipairs(conns2) do
            if type(conn.Function) == "function" then
                table.insert(data.triggerCallbacks, conn.Function)
            end
        end
    end
    
    if (#data.holdCallbacks > 0) or (#data.triggerCallbacks > 0) then
        InternalStealCache[prompt] = data
    end
end

local function runCallbackList(list)
    for _, fn in ipairs(list) do task.spawn(fn) end
end

-- ============================================================
-- BASE COORDINATES
-- ============================================================
local baseCoordinates = {
    left = {
        pos1 = CFrame.new(-370.50, -7.00, 58.80),
        pos2 = CFrame.new(-337.24, -5.04, 17.19),
        lastPos = CFrame.new(-352.98, -7.30, 45.76),
        lastPosPotion = CFrame.new(-353.16, -7.00, 43.02)
    },
    right = {
        pos1 = CFrame.new(-370.50, -7.00, 58.80),
        pos2 = CFrame.new(-336, -5, 102),
        lastPos = CFrame.new(-352.98, -7.30, 74.3),
        lastPosPotion = CFrame.new(-352.78, -7.00, 77.38)
    }
}

local function executeInternalStealAsync(prompt, animalData)
    local data = InternalStealCache[prompt]
    if not data or not data.ready then return false end
    
    data.ready = false
    isStealing = true
    stealProgress = 0
    currentTarget = animalData
    
    task.spawn(function()
        if #data.holdCallbacks > 0 then runCallbackList(data.holdCallbacks) end
        
        local startTime = tick()
        local potionUsed = false
        local carpetEquipped = false
        local teleportedFirst = false
        local teleported80 = false
        local teleportedFinal = false
        local base = baseCoordinates[selectedBase]
        
        while tick() - startTime < stealDuration and isStealing do
            stealProgress = (tick() - startTime) / stealDuration
            
            if stealProgress >= 0.90 and not potionUsed then
                potionUsed = true
                if CurrentConfig.Settings.AutoBigPotion then
                    task.spawn(useGiantPotion)
                end
            end
            
            if stealProgress >= 0.75 and not carpetEquipped then
                carpetEquipped = true
                local hrp = getHRP()
                if hrp then
                    local char = LocalPlayer.Character
                    if char then
                        local hum = char:FindFirstChildOfClass("Humanoid")
                        if hum then
                            local backpack = LocalPlayer:FindFirstChild("Backpack")
                            if backpack then
                                local carpet = backpack:FindFirstChild("Flying Carpet")
                                if carpet then hum:EquipTool(carpet) end
                            end
                        end
                    end
                end
            end
            
            if stealProgress >= 0.80 and not teleportedFirst then
                teleportedFirst = true
                local hrp = getHRP()
                if hrp then hrp.CFrame = base.pos1 end
            end
            
            if stealProgress >= 0.90 and not teleported80 then
                teleported80 = true
                local hrp = getHRP()
                if hrp then hrp.CFrame = base.pos2 end
            end
            
            if stealProgress >= 0.997 and not teleportedFinal then
                teleportedFinal = true
                local hrp = getHRP()
                if hrp then
                    if CurrentConfig.Settings.AutoBigPotion then
                        hrp.CFrame = base.lastPosPotion
                    else
                        hrp.CFrame = base.lastPos
                    end
                end
            end
            
            task.wait()
        end
        
        if #data.triggerCallbacks > 0 then runCallbackList(data.triggerCallbacks) end
        
        if not teleportedFinal then
            local hrp = getHRP()
            if hrp then
                if CurrentConfig.Settings.AutoBigPotion then
                    hrp.CFrame = base.lastPosPotion
                else
                    hrp.CFrame = base.lastPos
                end
            end
        end
        
        animalGrabbed = true
        task.wait(0.2)
        
        if CurrentConfig.Settings.AutoWalk then
            task.spawn(function()
                task.wait(0.1)
                optimizedAutoWalkWithOpposite(selectedBase)
            end)
        end
        
        task.wait(0.1)
        isStealing = false
        stealProgress = 0
        currentTarget = nil
        data.ready = true
        autoStealEnabled = false
        if updateUI then updateUI(false) end
    end)
    
    return true
end

local function attemptSteal(prompt, animalData)
    if not prompt or not prompt.Parent then return false end
    buildStealCallbacks(prompt)
    if not InternalStealCache[prompt] then return false end
    return executeInternalStealAsync(prompt, animalData)
end

local function prebuildStealCallbacks()
    for uid, prompt in pairs(PromptMemoryCache) do
        if prompt and prompt.Parent then buildStealCallbacks(prompt) end
    end
end

task.spawn(function()
    while task.wait(2) do
        if autoStealEnabled then prebuildStealCallbacks() end
    end
end)
-- ============================================================
-- SCANNER SYSTEM
-- ============================================================
local plotChannels = {}
local lastAnimalData = {}
local scannerConnections = {}

local function getAnimalHash(animalList)
    if not animalList then return "" end
    local hash = ""
    for slot, data in pairs(animalList) do
        if type(data) == "table" then
            hash = hash .. tostring(slot) .. tostring(data.Index) .. tostring(data.Mutation)
        end
    end
    return hash
end

local function scanSinglePlot(plot)
    pcall(function()        
        local plotUID = plot.Name
        local channel = Synchronizer:Get(plotUID)
        if not channel then return end
        
        local animalList = channel:Get("AnimalList")
        local currentHash = getAnimalHash(animalList)
        if lastAnimalData[plotUID] == currentHash then return end
        lastAnimalData[plotUID] = currentHash
        
        for i = #allAnimalsCache, 1, -1 do
            if allAnimalsCache[i].plot == plot.Name then
                table.remove(allAnimalsCache, i)
            end
        end
        
        local owner = channel:Get("Owner")
        if not owner or not Players:FindFirstChild(owner.Name) then
            for i = #allAnimalsCache, 1, -1 do
                if allAnimalsCache[i].plot == plot.Name then
                    table.remove(allAnimalsCache, i)
                end
            end
            return
        end
        
        local ownerName = owner and owner.Name or "Unknown"
        if not animalList then return end
        
        for slot, animalData in pairs(animalList) do
            if type(animalData) == "table" then
                local animalName = animalData.Index
                local animalInfo = AnimalsData[animalName]
                if not animalInfo then continue end
                
                local mutation = animalData.Mutation or "None"
                local traits = (animalData.Traits and #animalData.Traits > 0) and table.concat(animalData.Traits, ", ") or "None"
                local genValue = AnimalsShared:GetGeneration(animalName, animalData.Mutation, animalData.Traits, nil)
                local genText = "$" .. NumberUtils:ToString(genValue) .. "/s"
                
                table.insert(allAnimalsCache, {
                    name = animalInfo.DisplayName or animalName,
                    genText = genText,
                    genValue = genValue,
                    mutation = mutation,
                    traits = traits,
                    owner = ownerName,
                    plot = plot.Name,
                    slot = tostring(slot),
                    uid = plot.Name .. "_" .. tostring(slot),
                })
            end
        end
        
        table.sort(allAnimalsCache, function(a, b) return a.genValue > b.genValue end)
    end)
end

local function setupPlotListener(plot)
    if plotChannels[plot.Name] then return end
    
    local channel
    local retries = 0
    while not channel and retries < 10 do
        local success, result = pcall(function() return Synchronizer:Get(plot.Name) end)
        if success and result then
            channel = result
            break
        else
            retries = retries + 1
            if retries < 10 then task.wait(0.5) end
        end
    end
    
    if not channel then return end
    plotChannels[plot.Name] = true
    scanSinglePlot(plot)
    
    table.insert(scannerConnections, plot.DescendantAdded:Connect(function() task.wait(0.1) scanSinglePlot(plot) end))
    table.insert(scannerConnections, plot.DescendantRemoving:Connect(function() task.wait(0.1) scanSinglePlot(plot) end))
    
    task.spawn(function()
        while plot.Parent and plotChannels[plot.Name] do
            task.wait(5)
            scanSinglePlot(plot)
        end
    end)
end

local function initializePlotScanner()
    local plots = workspace:WaitForChild("Plots", 8)
    if not plots then return end
    
    for _, plot in ipairs(plots:GetChildren()) do setupPlotListener(plot) end
    
    table.insert(scannerConnections, plots.ChildAdded:Connect(function(plot)
        task.wait(0.5)
        setupPlotListener(plot)
    end))
    
    table.insert(scannerConnections, plots.ChildRemoved:Connect(function(plot)
        plotChannels[plot.Name] = nil
        lastAnimalData[plot.Name] = nil
        for i = #allAnimalsCache, 1, -1 do
            if allAnimalsCache[i].plot == plot.Name then
                table.remove(allAnimalsCache, i)
            end
        end
    end))
end

-- ============================================================
-- THEME ENGINE
-- ============================================================
local function getThemeButtonColor()
    local bg = CurrentConfig.Colors.Background
    local bgCol = Color3.fromRGB(bg[1], bg[2], bg[3])
    local h, s, v = bgCol:ToHSV()
    if v < 0.2 then
        return Color3.fromRGB(40, 20, 50)
    else
        return Color3.fromHSV(h, s, math.clamp(v - 0.1, 0, 1))
    end
end

local function UpdateToggleVisuals()
    for _, toggleData in ipairs(Toggles) do
        local key = toggleData.Key
        local btn = toggleData.Button
        local circle = toggleData.Circle
        local state = CurrentConfig.Settings[key]
        
        local targetPos = state and UDim2.new(1, -21, 0.5, -9) or UDim2.new(0, 3, 0.5, -9)
        local targetColor = state and Color3.fromRGB(180, 0, 255) or Color3.fromRGB(60, 60, 65)
        
        TweenService:Create(circle, TweenInfo.new(0.2), {Position = targetPos}):Play()
        TweenService:Create(btn, TweenInfo.new(0.2), {BackgroundColor3 = targetColor}):Play()
    end
end

local UpdateBaseIndicators

local function UpdateTheme()
    if not MainFrame then return end
    if CurrentConfig.Colors.Rainbow then return end

    local bg = CurrentConfig.Colors.Background
    local out = CurrentConfig.Colors.Outline
    local bgCol = Color3.fromRGB(bg[1], bg[2], bg[3])
    local outCol = Color3.fromRGB(out[1], out[2], out[3])
    local btnCol = getThemeButtonColor()
    
    TweenService:Create(MainFrame, TweenInfo.new(0.3), {BackgroundColor3 = bgCol}):Play()
    if Header then Header.BackgroundColor3 = bgCol end
    
    if MainGradient then
        MainGradient.Color = ColorSequence.new({
            ColorSequenceKeypoint.new(0, outCol),
            ColorSequenceKeypoint.new(0.5, Color3.new(1,1,1)),
            ColorSequenceKeypoint.new(1, outCol)
        })
    end

    if ButtonsContainer then
        for _, btn in pairs(ButtonsContainer:GetChildren()) do
            if btn:IsA("TextButton") then
                TweenService:Create(btn, TweenInfo.new(0.3), {BackgroundColor3 = btnCol}):Play()
            end
        end
    end
    
    local frames = {SettingsFrame, ColorFrame, AdvancedFrame}
    for _, frame in ipairs(frames) do
        if frame then
            for _, child in pairs(frame:GetChildren()) do
                if child:IsA("Frame") and not child.Name:find("Slider") and not child.Name:find("Progress") then
                    TweenService:Create(child, TweenInfo.new(0.3), {BackgroundColor3 = btnCol}):Play()
                end
                if child:IsA("TextButton") then
                    TweenService:Create(child, TweenInfo.new(0.3), {BackgroundColor3 = btnCol}):Play()
                end
            end
        end
    end
    
    if ProgressContainer then
        local stroke = ProgressContainer:FindFirstChild("UIStroke")
        if stroke then
            local gradient = stroke:FindFirstChildOfClass("UIGradient")
            if gradient then
                gradient.Color = ColorSequence.new({
                    ColorSequenceKeypoint.new(0, outCol),
                    ColorSequenceKeypoint.new(0.5, Color3.new(1,1,1)),
                    ColorSequenceKeypoint.new(1, outCol)
                })
            end
        end
    end
    
    if UpdateBaseIndicators then UpdateBaseIndicators() end
end

task.spawn(function()
    while true do
        if CurrentConfig.Colors.Rainbow and MainFrame then
            local speed = 0.2 + (CurrentConfig.Colors.RainbowSpeed * 1.5)
            local hue = tick() % (5/speed) / (5/speed)
            local bgRainbow = Color3.fromHSV(hue, 0.8, 0.15)
            local outlineRainbow = Color3.fromHSV(hue, 0.8, 1)
            
            MainFrame.BackgroundColor3 = bgRainbow
            if Header then Header.BackgroundColor3 = bgRainbow end
            
            if MainGradient then
                MainGradient.Color = ColorSequence.new({
                    ColorSequenceKeypoint.new(0, outlineRainbow),
                    ColorSequenceKeypoint.new(0.5, Color3.new(1,1,1)),
                    ColorSequenceKeypoint.new(1, outlineRainbow)
                })
            end
            
            if ProgressContainer then
                local stroke = ProgressContainer:FindFirstChild("UIStroke")
                if stroke then
                    local gradient = stroke:FindFirstChildOfClass("UIGradient")
                    if gradient then
                        gradient.Color = ColorSequence.new({
                            ColorSequenceKeypoint.new(0, outlineRainbow),
                            ColorSequenceKeypoint.new(0.5, Color3.new(1,1,1)),
                            ColorSequenceKeypoint.new(1, outlineRainbow)
                        })
                    end
                end
            end
        end
        RunService.Heartbeat:Wait()
    end
end)
-- ============================================================
-- PROGRESS BAR AT TOP OF SCREEN
-- ============================================================
local TopProgressGui = Instance.new("ScreenGui")
TopProgressGui.Name = randomString(24)
TopProgressGui.ResetOnSpawn = false
TopProgressGui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
TopProgressGui.IgnoreGuiInset = true
TopProgressGui.DisplayOrder = 999

if gethui then TopProgressGui.Parent = gethui()
else pcall(function() TopProgressGui.Parent = CoreGui end) end

local out = CurrentConfig.Colors.Outline
local outlineColor = Color3.fromRGB(out[1], out[2], out[3])

ProgressContainer = Instance.new("Frame")
ProgressContainer.Name = randomString(12)
ProgressContainer.Size = UDim2.new(0.12, 0, 0, 15)
ProgressContainer.Position = UDim2.new(0.5, 0, 0, 20)
ProgressContainer.AnchorPoint = Vector2.new(0.5, 0)
ProgressContainer.BackgroundColor3 = Color3.fromRGB(20, 10, 30)
ProgressContainer.BackgroundTransparency = 0.3
ProgressContainer.Visible = true
ProgressContainer.Parent = TopProgressGui
Instance.new("UICorner", ProgressContainer).CornerRadius = UDim.new(0, 4)

local ProgressStroke = Instance.new("UIStroke", ProgressContainer)
ProgressStroke.Thickness = 2
ProgressStroke.Color = Color3.fromRGB(255, 255, 255)

local ProgressGradient = Instance.new("UIGradient")
ProgressGradient.Color = ColorSequence.new({
    ColorSequenceKeypoint.new(0, outlineColor),
    ColorSequenceKeypoint.new(0.5, Color3.new(1,1,1)),
    ColorSequenceKeypoint.new(1, outlineColor)
})
ProgressGradient.Rotation = 45
ProgressGradient.Parent = ProgressStroke

task.spawn(function()
    local rot = 0
    while ProgressContainer and ProgressContainer.Parent do
        rot = rot + 1.5
        if ProgressGradient then ProgressGradient.Rotation = rot end
        RunService.Heartbeat:Wait()
    end
end)

ProgressFill = Instance.new("Frame")
ProgressFill.Size = UDim2.new(0, 0, 1, 0)
ProgressFill.BackgroundColor3 = Color3.fromRGB(100, 255, 100)
ProgressFill.BorderSizePixel = 0
ProgressFill.Parent = ProgressContainer
Instance.new("UICorner", ProgressFill).CornerRadius = UDim.new(0, 4)

-- ============================================================
-- UI CONSTRUCTION (COREGUI)
-- ============================================================
local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = randomString(20)
ScreenGui.ResetOnSpawn = false
ScreenGui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
ScreenGui.IgnoreGuiInset = true

if gethui then ScreenGui.Parent = gethui()
else pcall(function() ScreenGui.Parent = CoreGui end) end

ClickSound = Instance.new("Sound")
ClickSound.SoundId = "rbxassetid://6895079853"
ClickSound.Volume = 0.5
ClickSound.Parent = ScreenGui

-- Key listening connection
UserInputService.InputBegan:Connect(function(input, gameProcessed)
    if isListeningForKey and not gameProcessed then
        if input.UserInputType == Enum.UserInputType.Keyboard then
            local key = input.KeyCode
            if blockedKeys[key] then
                if keybindButton then
                    keybindButton.Text = "CAN'T USE MOVEMENT KEYS"
                    keybindButton.BackgroundColor3 = Color3.fromRGB(255, 0, 0)
                    task.wait(1)
                    if isListeningForKey then
                        keybindButton.Text = "Press any key..."
                        keybindButton.BackgroundColor3 = Color3.fromRGB(180, 0, 255)
                    else
                        keybindButton.Text = "SET KEYBIND"
                        keybindButton.BackgroundColor3 = Color3.fromRGB(60, 60, 65)
                    end
                end
                return
            end
            setKeybind(key)
            stopKeyListening()
        end
    end
end)

UserInputService.InputBegan:Connect(function(input)
    if isListeningForKey and input.UserInputType == Enum.UserInputType.MouseButton1 then
        if keybindButton and keybindButton.AbsolutePosition then
            local mousePos = Vector2.new(input.Position.X, input.Position.Y)
            local btnPos = keybindButton.AbsolutePosition
            local btnSize = keybindButton.AbsoluteSize
            if mousePos.X < btnPos.X or mousePos.X > btnPos.X + btnSize.X or
               mousePos.Y < btnPos.Y or mousePos.Y > btnPos.Y + btnSize.Y then
                stopKeyListening()
            end
        end
    end
end)

UserInputService.WindowFocusReleased:Connect(function()
    if isListeningForKey then stopKeyListening() end
end)

local StartupSound = Instance.new("Sound")
StartupSound.SoundId = "rbxassetid://6003770356"
StartupSound.Volume = 0.6
StartupSound.Parent = ScreenGui

local Blur = Instance.new("BlurEffect")
Blur.Size = 24
Blur.Parent = Lighting

local bg = CurrentConfig.Colors.Background
MainFrame = Instance.new("Frame")
MainFrame.Name = randomString(16)
MainFrame.Size = UDim2.new(0, 0, 0, 0)
MainFrame.Position = UDim2.new(0.5, 0, 0.5, 0)
MainFrame.AnchorPoint = Vector2.new(0.5, 0.5)
MainFrame.BackgroundColor3 = Color3.fromRGB(bg[1], bg[2], bg[3])
MainFrame.ClipsDescendants = false
MainFrame.ZIndex = 10
MainFrame.Visible = false
MainFrame.Parent = ScreenGui

Instance.new("UICorner", MainFrame).CornerRadius = UDim.new(0, 14)

local MainShadow = Instance.new("ImageLabel")
MainShadow.Name = "Shadow"
MainShadow.AnchorPoint = Vector2.new(0.5, 0.5)
MainShadow.BackgroundTransparency = 1
MainShadow.Position = UDim2.new(0.5, 0, 0.5, 0)
MainShadow.Size = UDim2.new(1, 55, 1, 55)
MainShadow.ZIndex = 0
MainShadow.Image = "rbxassetid://6015897843"
MainShadow.ImageColor3 = Color3.fromRGB(0, 0, 0)
MainShadow.ImageTransparency = 0.4
MainShadow.ScaleType = Enum.ScaleType.Slice
MainShadow.SliceCenter = Rect.new(49, 49, 450, 450)
MainShadow.Parent = MainFrame

local MainStroke = Instance.new("UIStroke", MainFrame)
MainStroke.Thickness = 2
MainStroke.Color = Color3.fromRGB(255, 255, 255)

out = CurrentConfig.Colors.Outline
MainGradient = Instance.new("UIGradient")
MainGradient.Color = ColorSequence.new({
    ColorSequenceKeypoint.new(0, Color3.fromRGB(out[1], out[2], out[3])),
    ColorSequenceKeypoint.new(0.5, Color3.new(1,1,1)),
    ColorSequenceKeypoint.new(1, Color3.fromRGB(out[1], out[2], out[3]))
})
MainGradient.Rotation = 45
MainGradient.Parent = MainStroke

task.spawn(function()
    local rot = 0
    while MainFrame.Parent do
        rot = rot + 1.5
        MainGradient.Rotation = rot
        RunService.Heartbeat:Wait()
    end
end)

Header = Instance.new("Frame")
Header.Name = "Header"
Header.Size = UDim2.new(1, 0, 0, IsMobile and 35 or 55)
Header.BackgroundTransparency = 1
Header.Parent = MainFrame
Instance.new("UICorner", Header).CornerRadius = UDim.new(0, 14)

local Title = Instance.new("TextLabel")
Title.Text = "Twocando & Artful Semi TP"
Title.Font = Enum.Font.GothamBlack
Title.TextColor3 = Color3.fromRGB(255, 255, 255)
Title.TextSize = IsMobile and 12 or 16
Title.Size = UDim2.new(1, -150, 1, 0)
Title.Position = UDim2.new(0, 10, 0, 5)
Title.BackgroundTransparency = 1
Title.TextXAlignment = Enum.TextXAlignment.Left
Title.Parent = Header

local TitleGradient = Instance.new("UIGradient")
TitleGradient.Color = ColorSequence.new({
    ColorSequenceKeypoint.new(0, Color3.fromRGB(180, 0, 255)),
    ColorSequenceKeypoint.new(1, Color3.fromRGB(255, 255, 255))
})
TitleGradient.Parent = Title

ButtonsContainer = Instance.new("Frame")
ButtonsContainer.Size = UDim2.new(0, 120, 1, 0)
ButtonsContainer.Position = UDim2.new(1, -125, 0, 5)
ButtonsContainer.BackgroundTransparency = 1
ButtonsContainer.Parent = Header

local function createHeaderBtn(name, text, order, widthOverride)
    local btn = Instance.new("TextButton")
    btn.Name = name
    btn.Text = text
    btn.Font = Enum.Font.GothamBold
    btn.TextSize = IsMobile and 14 or 16
    btn.TextColor3 = Color3.fromRGB(220, 220, 220)
    btn.BackgroundColor3 = getThemeButtonColor()
    local w = widthOverride or HeaderBtnSize
    btn.Size = UDim2.new(0, w, 0, HeaderBtnSize)
    btn.AnchorPoint = Vector2.new(0.5, 0.5)
    local offset = (w/2) + ((order - 1) * (w + 4))
    btn.Position = UDim2.new(1, -offset, 0.5, 0)
    btn.AutoButtonColor = false
    btn.Parent = ButtonsContainer
    Instance.new("UICorner", btn).CornerRadius = UDim.new(0, 8)
    btn.MouseEnter:Connect(function()
        TweenService:Create(btn, TweenInfo.new(0.2), {BackgroundColor3 = Color3.fromRGB(80, 40, 100)}):Play()
    end)
    btn.MouseLeave:Connect(function()
        TweenService:Create(btn, TweenInfo.new(0.2), {BackgroundColor3 = getThemeButtonColor()}):Play()
    end)
    btn.MouseButton1Click:Connect(function() ClickSound:Play() end)
    return btn
end

local MinimizeBtn = createHeaderBtn("Minimize", "-", 1)
local SettingsBtn = createHeaderBtn("Settings", "⚙", 2, IsMobile and 28 or 35)

local ContentFrame = Instance.new("Frame")
ContentFrame.Name = "Content"
ContentFrame.Size = UDim2.new(1, 0, 1, -(IsMobile and 35 or 55))
ContentFrame.Position = UDim2.new(0, 0, 0, IsMobile and 35 or 55)
ContentFrame.BackgroundTransparency = 1
ContentFrame.ClipsDescendants = true
ContentFrame.Parent = MainFrame

local Container = Instance.new("ScrollingFrame")
Container.Name = "StealControls"
Container.Size = UDim2.new(1, -16, 1, -10)
Container.Position = UDim2.new(0, 8, 0, 5)
Container.BackgroundTransparency = 1
Container.ScrollBarThickness = 3
Container.ScrollBarImageColor3 = Color3.fromRGB(180, 0, 255)
Container.AutomaticCanvasSize = Enum.AutomaticSize.Y
Container.CanvasSize = UDim2.new(0,0,0,0)
Container.Parent = ContentFrame

local UIListLayout = Instance.new("UIListLayout", Container)
UIListLayout.Padding = UDim.new(0, 8)
UIListLayout.SortOrder = Enum.SortOrder.LayoutOrder

local function createScrollFrame(name)
    local sf = Instance.new("ScrollingFrame")
    sf.Name = name
    sf.Size = UDim2.new(1, -16, 1, -10)
    sf.Position = UDim2.new(1.5, 0, 0, 5)
    sf.BackgroundTransparency = 1
    sf.ScrollBarThickness = 3
    sf.ScrollBarImageColor3 = Color3.fromRGB(180, 0, 255)
    sf.AutomaticCanvasSize = Enum.AutomaticSize.Y
    sf.CanvasSize = UDim2.new(0,0,0,0)
    sf.Parent = ContentFrame
    local layout = Instance.new("UIListLayout", sf)
    layout.Padding = UDim.new(0, 6)
    layout.SortOrder = Enum.SortOrder.LayoutOrder
    return sf
end

SettingsFrame = createScrollFrame("SettingsPage")
ColorFrame = createScrollFrame("ColorPage")
AdvancedFrame = createScrollFrame("AdvancedPage")

local function createBackBtn(parent, targetFrame)
    local frame = Instance.new("Frame")
    frame.Size = UDim2.new(1, 0, 0, 35)
    frame.BackgroundTransparency = 1
    frame.LayoutOrder = -1
    frame.Parent = parent
    local backBtn = Instance.new("TextButton")
    backBtn.Text = "← Back"
    backBtn.Font = Enum.Font.GothamBold
    backBtn.TextSize = IsMobile and 12 or 14
    backBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
    backBtn.BackgroundColor3 = Color3.fromRGB(120, 0, 180)
    backBtn.Size = UDim2.new(1, 0, 1, 0)
    backBtn.Parent = frame
    Instance.new("UICorner", backBtn).CornerRadius = UDim.new(0, 8)
    backBtn.MouseButton1Click:Connect(function()
        ClickSound:Play()
        TweenService:Create(parent, TweenInfo.new(0.3, Enum.EasingStyle.Quart, Enum.EasingDirection.Out), {Position = UDim2.new(1.5, 0, 0, 10)}):Play()
        task.wait(0.2)
        parent.Visible = false
        targetFrame.Visible = true
        TweenService:Create(targetFrame, TweenInfo.new(0.3, Enum.EasingStyle.Quart, Enum.EasingDirection.Out), {Position = UDim2.new(0, 10, 0, 10)}):Play()
    end)
end

createBackBtn(SettingsFrame, Container)
createBackBtn(ColorFrame, SettingsFrame)
createBackBtn(AdvancedFrame, SettingsFrame)

local function hideAllFrames()
    Container.Visible = false
    SettingsFrame.Visible = false
    ColorFrame.Visible = false
    AdvancedFrame.Visible = false
end

SettingsBtn.MouseButton1Click:Connect(function()
    ClickSound:Play()
    hideAllFrames()
    SettingsFrame.Visible = true
    SettingsFrame.Position = UDim2.new(1.5, 0, 0, 10)
    TweenService:Create(SettingsFrame, TweenInfo.new(0.3, Enum.EasingStyle.Quart, Enum.EasingDirection.Out), {Position = UDim2.new(0, 10, 0, 10)}):Play()
end)

local expanded = true
MinimizeBtn.MouseButton1Click:Connect(function()
    ClickSound:Play()
    expanded = not expanded
    if expanded then
        TweenService:Create(MainFrame, TweenInfo.new(0.4, Enum.EasingStyle.Back, Enum.EasingDirection.Out), {Size = UDim2.new(0, CurrentConfig.Size.Width, 0, CurrentConfig.Size.Height)}):Play()
        Container.Visible = true
        MinimizeBtn.Text = "-"
    else
        TweenService:Create(MainFrame, TweenInfo.new(0.4, Enum.EasingStyle.Back, Enum.EasingDirection.Out), {Size = UDim2.new(0, CurrentConfig.Size.Width, 0, IsMobile and 35 or 55)}):Play()
        hideAllFrames()
        MinimizeBtn.Text = "+"
    end
end)
-- ============================================================
-- MAIN CONTENT - STEAL CONTROLS
-- ============================================================
local RadiusFrame = Instance.new("Frame")
RadiusFrame.Name = "RadiusControl"
RadiusFrame.Size = UDim2.new(1, 0, 0, 70)
RadiusFrame.BackgroundColor3 = getThemeButtonColor()
RadiusFrame.LayoutOrder = 1
RadiusFrame.Parent = Container
Instance.new("UICorner", RadiusFrame).CornerRadius = UDim.new(0, 8)

local RadiusLabel = Instance.new("TextLabel")
RadiusLabel.Size = UDim2.new(0.5, 0, 0, 25)
RadiusLabel.Position = UDim2.new(0, 10, 0, 5)
RadiusLabel.BackgroundTransparency = 1
RadiusLabel.Text = "Steal Radius:"
RadiusLabel.Font = Enum.Font.GothamBold
RadiusLabel.TextSize = 14
RadiusLabel.TextColor3 = Color3.fromRGB(200, 200, 200)
RadiusLabel.TextXAlignment = Enum.TextXAlignment.Left
RadiusLabel.Parent = RadiusFrame

local RadiusValue = Instance.new("TextLabel")
RadiusValue.Size = UDim2.new(0.5, -10, 0, 25)
RadiusValue.Position = UDim2.new(0.5, 0, 0, 5)
RadiusValue.BackgroundTransparency = 1
RadiusValue.Text = stealRadius .. " studs"
RadiusValue.Font = Enum.Font.GothamBold
RadiusValue.TextSize = 14
RadiusValue.TextColor3 = Color3.fromRGB(180, 0, 255)
RadiusValue.TextXAlignment = Enum.TextXAlignment.Right
RadiusValue.Parent = RadiusFrame

local SliderBg = Instance.new("Frame")
SliderBg.Size = UDim2.new(1, -20, 0, 8)
SliderBg.Position = UDim2.new(0, 10, 0, 38)
SliderBg.BackgroundColor3 = Color3.fromRGB(50, 50, 50)
SliderBg.Parent = RadiusFrame
Instance.new("UICorner", SliderBg).CornerRadius = UDim.new(0, 4)

local SliderFill = Instance.new("Frame")
SliderFill.Size = UDim2.new((stealRadius - 10) / 90, 0, 1, 0)
SliderFill.BackgroundColor3 = Color3.fromRGB(180, 0, 255)
SliderFill.Parent = SliderBg
Instance.new("UICorner", SliderFill).CornerRadius = UDim.new(0, 4)

local SliderButton = Instance.new("TextButton")
SliderButton.Size = UDim2.new(0, 18, 0, 18)
SliderButton.Position = UDim2.new(SliderFill.Size.X.Scale, -9, 0, -5)
SliderButton.BackgroundColor3 = Color3.fromRGB(255, 255, 255)
SliderButton.Text = ""
SliderButton.Parent = SliderBg
Instance.new("UICorner", SliderButton).CornerRadius = UDim.new(0, 9)

local sliderDragging = false
SliderButton.MouseButton1Down:Connect(function() sliderDragging = true end)

UserInputService.InputEnded:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
        if sliderDragging then
            sliderDragging = false
            CurrentConfig.StealRadius = stealRadius
            saveConfig()
        end
    end
end)

UserInputService.InputChanged:Connect(function(input)
    if sliderDragging and (input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch) then
        local mousePos = UserInputService:GetMouseLocation()
        local sliderPos = SliderBg.AbsolutePosition
        local sliderSize = SliderBg.AbsoluteSize
        local relativeX = math.clamp(mousePos.X - sliderPos.X, 0, sliderSize.X)
        local percentage = relativeX / sliderSize.X
        stealRadius = math.floor(10 + (percentage * 90))
        SliderFill.Size = UDim2.new(percentage, 0, 1, 0)
        SliderButton.Position = UDim2.new(percentage, -9, 0, -5)
        RadiusValue.Text = stealRadius .. " studs"
    end
end)

local StatusRow = Instance.new("Frame")
StatusRow.Name = "StatusRow"
StatusRow.Size = UDim2.new(1, 0, 0, 45)
StatusRow.BackgroundColor3 = getThemeButtonColor()
StatusRow.LayoutOrder = 2
StatusRow.Parent = Container
Instance.new("UICorner", StatusRow).CornerRadius = UDim.new(0, 8)

local NearbyLabel = Instance.new("TextLabel")
NearbyLabel.Size = UDim2.new(0.35, 0, 1, 0)
NearbyLabel.Position = UDim2.new(0, 10, 0, 0)
NearbyLabel.BackgroundTransparency = 1
NearbyLabel.Text = "In Range:"
NearbyLabel.Font = Enum.Font.GothamBold
NearbyLabel.TextSize = 12
NearbyLabel.TextColor3 = Color3.fromRGB(200, 200, 200)
NearbyLabel.TextXAlignment = Enum.TextXAlignment.Left
NearbyLabel.Parent = StatusRow

NearbyCountLabel = Instance.new("TextLabel")
NearbyCountLabel.Size = UDim2.new(0.15, 0, 1, 0)
NearbyCountLabel.Position = UDim2.new(0.20, 0, 0, 0)
NearbyCountLabel.BackgroundTransparency = 1
NearbyCountLabel.Text = "0"
NearbyCountLabel.Font = Enum.Font.GothamBold
NearbyCountLabel.TextSize = 16
NearbyCountLabel.TextColor3 = Color3.fromRGB(180, 0, 255)
NearbyCountLabel.TextXAlignment = Enum.TextXAlignment.Left
NearbyCountLabel.Parent = StatusRow

PotionStatusLabel = Instance.new("TextLabel")
PotionStatusLabel.Size = UDim2.new(0.45, -10, 1, 0)
PotionStatusLabel.Position = UDim2.new(0.55, 0, 0, 0)
PotionStatusLabel.BackgroundTransparency = 1
PotionStatusLabel.Text = "Potion: ❌"
PotionStatusLabel.Font = Enum.Font.GothamBold
PotionStatusLabel.TextSize = 12
PotionStatusLabel.TextColor3 = Color3.fromRGB(100, 255, 100)
PotionStatusLabel.TextXAlignment = Enum.TextXAlignment.Right
PotionStatusLabel.Parent = StatusRow

task.spawn(function()
    while task.wait(1) do
        local backpack = LocalPlayer:FindFirstChild("Backpack")
        local char = LocalPlayer.Character
        local hasPotion = false
        if backpack and backpack:FindFirstChild(POTION_NAME) then hasPotion = true
        elseif char and char:FindFirstChild(POTION_NAME) then hasPotion = true end
        if hasPotion then
            PotionStatusLabel.Text = "Potion: ✔️"
            PotionStatusLabel.TextColor3 = Color3.fromRGB(100, 255, 100)
        else
            PotionStatusLabel.Text = "Potion: ❌"
            PotionStatusLabel.TextColor3 = Color3.fromRGB(255, 100, 100)
        end
    end
end)

-- BASE SELECTION
local BaseFrame = Instance.new("Frame")
BaseFrame.Name = "BaseSelection"
BaseFrame.Size = UDim2.new(1, 0, 0, 50)
BaseFrame.BackgroundColor3 = getThemeButtonColor()
BaseFrame.LayoutOrder = 3
BaseFrame.Parent = Container
Instance.new("UICorner", BaseFrame).CornerRadius = UDim.new(0, 8)

local BaseLabel = Instance.new("TextLabel")
BaseLabel.Size = UDim2.new(0.3, 0, 1, 0)
BaseLabel.Position = UDim2.new(0, 10, 0, 0)
BaseLabel.BackgroundTransparency = 1
BaseLabel.Text = "Base:"
BaseLabel.Font = Enum.Font.GothamBold
BaseLabel.TextSize = 14
BaseLabel.TextColor3 = Color3.fromRGB(200, 200, 200)
BaseLabel.TextXAlignment = Enum.TextXAlignment.Left
BaseLabel.Parent = BaseFrame

local SplitContainer = Instance.new("Frame")
SplitContainer.Size = UDim2.new(0.6, 0, 0, 30)
SplitContainer.Position = UDim2.new(0.35, 0, 0.5, -15)
SplitContainer.BackgroundColor3 = Color3.fromRGB(40, 40, 45)
SplitContainer.Parent = BaseFrame
Instance.new("UICorner", SplitContainer).CornerRadius = UDim.new(0, 6)

local LeftBaseBtn = Instance.new("TextButton")
LeftBaseBtn.Name = "LeftBaseBtn"
LeftBaseBtn.Size = UDim2.new(0.5, -1, 1, 0)
LeftBaseBtn.Position = UDim2.new(0, 0, 0, 0)
LeftBaseBtn.BackgroundColor3 = selectedBase == "left" and Color3.fromRGB(180, 0, 255) or Color3.fromRGB(60, 60, 65)
LeftBaseBtn.Text = "LEFT"
LeftBaseBtn.Font = Enum.Font.GothamBold
LeftBaseBtn.TextSize = 12
LeftBaseBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
LeftBaseBtn.AutoButtonColor = false
LeftBaseBtn.Parent = SplitContainer
Instance.new("UICorner", LeftBaseBtn).CornerRadius = UDim.new(0, 6)

local RightBaseBtn = Instance.new("TextButton")
RightBaseBtn.Name = "RightBaseBtn"
RightBaseBtn.Size = UDim2.new(0.5, -1, 1, 0)
RightBaseBtn.Position = UDim2.new(0.5, 1, 0, 0)
RightBaseBtn.BackgroundColor3 = selectedBase == "right" and Color3.fromRGB(180, 0, 255) or Color3.fromRGB(60, 60, 65)
RightBaseBtn.Text = "RIGHT"
RightBaseBtn.Font = Enum.Font.GothamBold
RightBaseBtn.TextSize = 12
RightBaseBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
RightBaseBtn.AutoButtonColor = false
RightBaseBtn.Parent = SplitContainer
Instance.new("UICorner", RightBaseBtn).CornerRadius = UDim.new(0, 6)

LeftBaseBtn.MouseButton1Click:Connect(function()
    ClickSound:Play()
    if selectedBase ~= "left" then
        selectedBase = "left"
        LeftBaseBtn.BackgroundColor3 = Color3.fromRGB(180, 0, 255)
        RightBaseBtn.BackgroundColor3 = Color3.fromRGB(60, 60, 65)
    end
end)

RightBaseBtn.MouseButton1Click:Connect(function()
    ClickSound:Play()
    if selectedBase ~= "right" then
        selectedBase = "right"
        RightBaseBtn.BackgroundColor3 = Color3.fromRGB(180, 0, 255)
        LeftBaseBtn.BackgroundColor3 = Color3.fromRGB(60, 60, 65)
    end
end)

-- KEYBIND BUTTON
local KeybindFrame = Instance.new("Frame")
KeybindFrame.Name = "KeybindControl"
KeybindFrame.Size = UDim2.new(1, 0, 0, 50)
KeybindFrame.BackgroundColor3 = getThemeButtonColor()
KeybindFrame.LayoutOrder = 4
KeybindFrame.Parent = Container
Instance.new("UICorner", KeybindFrame).CornerRadius = UDim.new(0, 8)

local KeybindLabelTitle = Instance.new("TextLabel")
KeybindLabelTitle.Size = UDim2.new(0.4, 0, 1, 0)
KeybindLabelTitle.Position = UDim2.new(0, 10, 0, 0)
KeybindLabelTitle.BackgroundTransparency = 1
KeybindLabelTitle.Text = "Toggle Key:"
KeybindLabelTitle.Font = Enum.Font.GothamBold
KeybindLabelTitle.TextSize = 14
KeybindLabelTitle.TextColor3 = Color3.fromRGB(200, 200, 200)
KeybindLabelTitle.TextXAlignment = Enum.TextXAlignment.Left
KeybindLabelTitle.Parent = KeybindFrame

keybindButton = Instance.new("TextButton")
keybindButton.Size = UDim2.new(0.35, -10, 0, 30)
keybindButton.Position = UDim2.new(0.6, 0, 0.5, -15)
keybindButton.BackgroundColor3 = Color3.fromRGB(60, 60, 65)
keybindButton.Text = "SET KEYBIND"
keybindButton.Font = Enum.Font.GothamBold
keybindButton.TextSize = 12
keybindButton.TextColor3 = Color3.fromRGB(255, 255, 255)
keybindButton.AutoButtonColor = false
keybindButton.Parent = KeybindFrame
Instance.new("UICorner", keybindButton).CornerRadius = UDim.new(0, 6)

keybindLabel = Instance.new("TextLabel")
keybindLabel.Size = UDim2.new(0.25, -5, 1, 0)
keybindLabel.Position = UDim2.new(0.35, 0, 0, 0)
keybindLabel.BackgroundTransparency = 1
keybindLabel.Font = Enum.Font.GothamBold
keybindLabel.TextSize = 16
keybindLabel.TextColor3 = Color3.fromRGB(180, 0, 255)
keybindLabel.TextXAlignment = Enum.TextXAlignment.Center
keybindLabel.Parent = KeybindFrame
updateKeybindDisplay()

keybindButton.MouseButton1Click:Connect(function()
    ClickSound:Play()
    if not isListeningForKey then startKeyListening() else stopKeyListening() end
end)
-- Spacer and buttons
local Spacer = Instance.new("Frame")
Spacer.Name = "Spacer"
Spacer.Size = UDim2.new(1, 0, 0, 0)
Spacer.BackgroundTransparency = 1
Spacer.LayoutOrder = 6
Spacer.Parent = Container

local SpacerLayout = Instance.new("UIListLayout", Spacer)
SpacerLayout.VerticalAlignment = Enum.VerticalAlignment.Bottom
SpacerLayout.FillDirection = Enum.FillDirection.Vertical

local StealButton = Instance.new("TextButton")
StealButton.Name = "StealButton"
StealButton.Size = UDim2.new(1, 0, 0, 55)
StealButton.BackgroundColor3 = Color3.fromRGB(30, 0, 50)
StealButton.Text = "TELEPORT"
StealButton.Font = Enum.Font.GothamBold
StealButton.TextSize = 18
StealButton.TextColor3 = Color3.fromRGB(230, 175, 255)
StealButton.AutoButtonColor = false
StealButton.LayoutOrder = 7
StealButton.Parent = Spacer
Instance.new("UICorner", StealButton).CornerRadius = UDim.new(0, 8)

local StealButtonGradient = Instance.new("UIGradient")
StealButtonGradient.Color = ColorSequence.new{
    ColorSequenceKeypoint.new(0, Color3.fromRGB(180, 0, 255)),
    ColorSequenceKeypoint.new(1, Color3.fromRGB(255, 150, 255))
}
StealButtonGradient.Parent = StealButton

local StealButtonStroke = Instance.new("UIStroke")
StealButtonStroke.Color = Color3.fromRGB(180, 0, 255)
StealButtonStroke.Thickness = 2
StealButtonStroke.Parent = StealButton

StealButton.MouseEnter:Connect(function()
    if not autoStealEnabled and not isStealing then
        TweenService:Create(StealButton, TweenInfo.new(0.2), {BackgroundColor3 = Color3.fromRGB(50, 0, 80)}):Play()
        TweenService:Create(StealButtonStroke, TweenInfo.new(0.2), {Transparency = 0}):Play()
    end
end)

StealButton.MouseLeave:Connect(function()
    if not autoStealEnabled and not isStealing then
        TweenService:Create(StealButton, TweenInfo.new(0.2), {BackgroundColor3 = Color3.fromRGB(30, 0, 50)}):Play()
        TweenService:Create(StealButtonStroke, TweenInfo.new(0.2), {Transparency = 0.3}):Play()
    end
end)

DesyncResetButton = Instance.new("TextButton")
DesyncResetButton.Name = "DesyncResetButton"
DesyncResetButton.Size = UDim2.new(1, 0, 0, 45)
DesyncResetButton.BackgroundColor3 = Color3.fromRGB(80, 0, 0)
DesyncResetButton.Text = "Activate to work"
DesyncResetButton.Font = Enum.Font.GothamBold
DesyncResetButton.TextSize = 16
DesyncResetButton.TextColor3 = Color3.fromRGB(255, 200, 200)
DesyncResetButton.AutoButtonColor = false
DesyncResetButton.LayoutOrder = 5
DesyncResetButton.Visible = not CurrentConfig.Settings.AutoResetOnStart
DesyncResetButton.Parent = Container
Instance.new("UICorner", DesyncResetButton).CornerRadius = UDim.new(0, 8)

local DesyncButtonStroke = Instance.new("UIStroke")
DesyncButtonStroke.Color = Color3.fromRGB(255, 100, 100)
DesyncButtonStroke.Thickness = 1.5
DesyncButtonStroke.Parent = DesyncResetButton

DesyncResetButton.MouseEnter:Connect(function()
    TweenService:Create(DesyncResetButton, TweenInfo.new(0.2), {BackgroundColor3 = Color3.fromRGB(120, 0, 0)}):Play()
end)

DesyncResetButton.MouseLeave:Connect(function()
    TweenService:Create(DesyncResetButton, TweenInfo.new(0.2), {BackgroundColor3 = Color3.fromRGB(80, 0, 0)}):Play()
end)

DesyncResetButton.MouseButton1Click:Connect(function()
    ClickSound:Play()
    DesyncResetButton.Text = "Activating..."
    resetDesync()
    task.wait(2)
    DesyncResetButton.Text = "Almost done"
    task.wait(2)
    DesyncResetButton.Text = "Done"
    task.wait(1)
    DesyncResetButton.Text = "Activate to work"
end)

local function UpdateSpacerHeight()
    local desyncVisible = DesyncResetButton and DesyncResetButton.Visible
    if desyncVisible then
        Spacer.Size = UDim2.new(1, 0, 0, 135)
    else
        Spacer.Size = UDim2.new(1, 0, 0, 185)
    end
end

task.spawn(function()
    task.wait(0.5)
    UpdateSpacerHeight()
end)

local oldSetting = CurrentConfig.Settings.AutoResetOnStart
task.spawn(function()
    while task.wait(0.5) do
        if oldSetting ~= CurrentConfig.Settings.AutoResetOnStart then
            oldSetting = CurrentConfig.Settings.AutoResetOnStart
            UpdateSpacerHeight()
        end
    end
end)

-- ============================================================
-- SETTINGS ELEMENTS
-- ============================================================
local function CreateToggle(name, configKey, callback, parentFrame)
    local parent = parentFrame or SettingsFrame
    local frame = Instance.new("Frame")
    frame.Size = UDim2.new(1, 0, 0, 50)
    frame.BackgroundColor3 = getThemeButtonColor()
    frame.Parent = parent
    Instance.new("UICorner", frame).CornerRadius = UDim.new(0, 8)
    
    local label = Instance.new("TextLabel")
    label.Text = name
    label.Font = Enum.Font.GothamMedium
    label.TextSize = 14
    label.TextColor3 = Color3.fromRGB(230, 230, 230)
    label.Size = UDim2.new(0.6, 0, 1, 0)
    label.Position = UDim2.new(0, 15, 0, 0)
    label.BackgroundTransparency = 1
    label.TextXAlignment = Enum.TextXAlignment.Left
    label.Parent = frame
    
    local toggleBtn = Instance.new("TextButton")
    toggleBtn.Text = ""
    toggleBtn.Size = UDim2.new(0, 45, 0, 24)
    toggleBtn.Position = UDim2.new(1, -60, 0.5, -12)
    toggleBtn.BackgroundColor3 = CurrentConfig.Settings[configKey] and Color3.fromRGB(180, 0, 255) or Color3.fromRGB(60, 60, 65)
    toggleBtn.AutoButtonColor = false
    toggleBtn.Parent = frame
    Instance.new("UICorner", toggleBtn).CornerRadius = UDim.new(1, 0)
    
    local circle = Instance.new("Frame")
    circle.Size = UDim2.new(0, 18, 0, 18)
    circle.Position = CurrentConfig.Settings[configKey] and UDim2.new(1, -21, 0.5, -9) or UDim2.new(0, 3, 0.5, -9)
    circle.BackgroundColor3 = Color3.fromRGB(255, 255, 255)
    circle.Parent = toggleBtn
    Instance.new("UICorner", circle).CornerRadius = UDim.new(1, 0)
    
    table.insert(Toggles, {Key = configKey, Button = toggleBtn, Circle = circle})
    
    toggleBtn.MouseButton1Click:Connect(function()
        ClickSound:Play()
        CurrentConfig.Settings[configKey] = not CurrentConfig.Settings[configKey]
        UpdateToggleVisuals()
        saveConfig()
        if callback then callback(CurrentConfig.Settings[configKey]) end
    end)
end

local function CreateSettingsNavBtn(text, targetFrame)
    local btn = Instance.new("TextButton")
    btn.Text = text
    btn.Font = Enum.Font.GothamBold
    btn.TextSize = 14
    btn.TextColor3 = Color3.fromRGB(255, 255, 255)
    btn.BackgroundColor3 = getThemeButtonColor()
    btn.Size = UDim2.new(1, 0, 0, 45)
    btn.Parent = SettingsFrame
    Instance.new("UICorner", btn).CornerRadius = UDim.new(0, 8)
    btn.MouseButton1Click:Connect(function()
        ClickSound:Play()
        SettingsFrame.Visible = false
        targetFrame.Visible = true
        targetFrame.Position = UDim2.new(1.5, 0, 0, 10)
        TweenService:Create(targetFrame, TweenInfo.new(0.3, Enum.EasingStyle.Quart, Enum.EasingDirection.Out), {Position = UDim2.new(0, 10, 0, 10)}):Play()
    end)
end

local function createRainbowControl()
    local container = Instance.new("Frame")
    container.Size = UDim2.new(1, 0, 0, 50)
    container.BackgroundColor3 = Color3.fromRGB(25, 15, 35)
    container.Parent = ColorFrame
    Instance.new("UICorner", container).CornerRadius = UDim.new(0, 8)
    
    local label = Instance.new("TextLabel")
    label.Text = "Rainbow Mode"
    label.Font = Enum.Font.GothamBold
    label.TextSize = 14
    label.TextColor3 = Color3.fromRGB(255, 255, 255)
    label.Size = UDim2.new(0.6, 0, 1, 0)
    label.Position = UDim2.new(0, 15, 0, 0)
    label.BackgroundTransparency = 1
    label.TextXAlignment = Enum.TextXAlignment.Left
    label.Parent = container
    
    local toggleBtn = Instance.new("TextButton")
    toggleBtn.Text = CurrentConfig.Colors.Rainbow and "ON" or "OFF"
    toggleBtn.Size = UDim2.new(0, 50, 0, 30)
    toggleBtn.Position = UDim2.new(1, -60, 0.5, -15)
    toggleBtn.BackgroundColor3 = CurrentConfig.Colors.Rainbow and Color3.fromRGB(180, 0, 255) or Color3.fromRGB(50, 50, 60)
    toggleBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
    toggleBtn.Font = Enum.Font.GothamBold
    toggleBtn.Parent = container
    Instance.new("UICorner", toggleBtn).CornerRadius = UDim.new(0, 6)
    
    toggleBtn.MouseButton1Click:Connect(function()
        ClickSound:Play()
        CurrentConfig.Colors.Rainbow = not CurrentConfig.Colors.Rainbow
        toggleBtn.Text = CurrentConfig.Colors.Rainbow and "ON" or "OFF"
        toggleBtn.BackgroundColor3 = CurrentConfig.Colors.Rainbow and Color3.fromRGB(180, 0, 255) or Color3.fromRGB(50, 50, 60)
        if not CurrentConfig.Colors.Rainbow then UpdateTheme() end
        saveConfig()
    end)
end

local function createRGBGroup(name, targetKey)
    local group = Instance.new("Frame")
    group.Size = UDim2.new(1, 0, 0, 140)
    group.BackgroundColor3 = Color3.fromRGB(25, 15, 35)
    group.Parent = ColorFrame
    Instance.new("UICorner", group).CornerRadius = UDim.new(0, 8)
    
    local title = Instance.new("TextLabel")
    title.Text = name
    title.Font = Enum.Font.GothamBold
    title.TextSize = 14
    title.TextColor3 = Color3.fromRGB(200, 200, 200)
    title.Size = UDim2.new(1, 0, 0, 20)
    title.Position = UDim2.new(0, 10, 0, 5)
    title.BackgroundTransparency = 1
    title.TextXAlignment = Enum.TextXAlignment.Left
    title.Parent = group
    
    local labels = {"R", "G", "B"}
    for i, char in ipairs(labels) do
        local container = Instance.new("Frame")
        container.Size = UDim2.new(0.9, 0, 0, 30)
        container.Position = UDim2.new(0.05, 0, 0, 25 + (i-1)*35)
        container.BackgroundTransparency = 1
        container.Parent = group
        
        local lbl = Instance.new("TextLabel", container)
        lbl.Text = char
        lbl.Size = UDim2.new(0, 20, 1, 0)
        lbl.TextColor3 = Color3.fromRGB(150, 150, 150)
        lbl.BackgroundTransparency = 1
        lbl.Font = Enum.Font.GothamBold
        
        local sliderBg = Instance.new("Frame", container)
        sliderBg.Name = "SliderBg"
        sliderBg.Size = UDim2.new(1, -30, 0, 4)
        sliderBg.Position = UDim2.new(0, 30, 0.5, -2)
        sliderBg.BackgroundColor3 = Color3.fromRGB(50, 50, 60)
        Instance.new("UICorner", sliderBg).CornerRadius = UDim.new(1,0)
        
        local currentValue = CurrentConfig.Colors[targetKey][i]
        local fill = Instance.new("Frame", sliderBg)
        fill.Name = "Fill"
        fill.Size = UDim2.new(currentValue / 255, 0, 1, 0)
        fill.BackgroundColor3 = i==1 and Color3.fromRGB(255,80,80) or i==2 and Color3.fromRGB(80,255,80) or Color3.fromRGB(80,80,255)
        Instance.new("UICorner", fill).CornerRadius = UDim.new(1,0)
        
        local trigger = Instance.new("TextButton", sliderBg)
        trigger.Size = UDim2.new(1, 0, 3, 0)
        trigger.Position = UDim2.new(0, 0, -1, 0)
        trigger.BackgroundTransparency = 1
        trigger.Text = ""
        
        local isDragging = false
        trigger.InputBegan:Connect(function(input)
            if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
                isDragging = true
                local moveConn, endConn
                local function update(pos)
                    if not isDragging then return end
                    local relX = math.clamp((pos.X - sliderBg.AbsolutePosition.X) / sliderBg.AbsoluteSize.X, 0, 1)
                    fill.Size = UDim2.new(relX, 0, 1, 0)
                    CurrentConfig.Colors[targetKey][i] = math.floor(relX * 255)
                    UpdateTheme()
                end
                update(input.Position)
                moveConn = UserInputService.InputChanged:Connect(function(inp)
                    if inp.UserInputType == Enum.UserInputType.MouseMovement or inp.UserInputType == Enum.UserInputType.Touch then
                        update(inp.Position)
                    end
                end)
                endConn = UserInputService.InputEnded:Connect(function(inp)
                    if inp.UserInputType == Enum.UserInputType.MouseButton1 or inp.UserInputType == Enum.UserInputType.Touch then
                        isDragging = false
                        if moveConn then moveConn:Disconnect() end
                        if endConn then endConn:Disconnect() end
                        saveConfig()
                    end
                end)
            end
        end)
    end
end

local function createSizeSlider(name, minVal, maxVal, currentVal, axis)
    local container = Instance.new("Frame")
    container.Size = UDim2.new(1, 0, 0, 50)
    container.BackgroundColor3 = Color3.fromRGB(30, 35, 45)
    container.Parent = AdvancedFrame
    Instance.new("UICorner", container).CornerRadius = UDim.new(0, 8)
    
    local lbl = Instance.new("TextLabel")
    lbl.Text = name .. ": " .. currentVal
    lbl.Size = UDim2.new(1, 0, 0, 20)
    lbl.Position = UDim2.new(0, 15, 0, 5)
    lbl.BackgroundTransparency = 1
    lbl.TextColor3 = Color3.fromRGB(230, 230, 230)
    lbl.Font = Enum.Font.GothamBold
    lbl.TextSize = 12
    lbl.TextXAlignment = Enum.TextXAlignment.Left
    lbl.Parent = container
    
    local sliderBg = Instance.new("Frame")
    sliderBg.Size = UDim2.new(0.9, 0, 0, 6)
    sliderBg.Position = UDim2.new(0.05, 0, 0.60, 0)
    sliderBg.BackgroundColor3 = Color3.fromRGB(50, 55, 70)
    sliderBg.Parent = container
    Instance.new("UICorner", sliderBg).CornerRadius = UDim.new(1, 0)
    
    local fill = Instance.new("Frame")
    local startAlpha = (currentVal - minVal) / (maxVal - minVal)
    fill.Size = UDim2.new(startAlpha, 0, 1, 0)
    fill.BackgroundColor3 = Color3.fromRGB(180, 0, 255)
    fill.Parent = sliderBg
    Instance.new("UICorner", fill).CornerRadius = UDim.new(1, 0)
    
    local trigger = Instance.new("TextButton")
    trigger.Size = UDim2.new(1, 0, 4, 0)
    trigger.Position = UDim2.new(0, 0, -1.5, 0)
    trigger.BackgroundTransparency = 1
    trigger.Text = ""
    trigger.Parent = sliderBg
    
    local isDragging = false
    trigger.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
            isDragging = true
            local moveConn, endConn
            local function update(pos)
                if not isDragging then return end
                local relX = math.clamp((pos.X - sliderBg.AbsolutePosition.X) / sliderBg.AbsoluteSize.X, 0, 1)
                local newVal = math.floor(minVal + (relX * (maxVal - minVal)))
                fill.Size = UDim2.new(relX, 0, 1, 0)
                lbl.Text = name .. ": " .. newVal
                if axis == "X" then
                    MainFrame.Size = UDim2.new(0, newVal, 0, MainFrame.Size.Y.Offset)
                    CurrentConfig.Size.Width = newVal
                else
                    MainFrame.Size = UDim2.new(0, MainFrame.Size.X.Offset, 0, newVal)
                    CurrentConfig.Size.Height = newVal
                end
            end
            update(input.Position)
            moveConn = UserInputService.InputChanged:Connect(function(inp)
                if inp.UserInputType == Enum.UserInputType.MouseMovement or inp.UserInputType == Enum.UserInputType.Touch then
                    update(inp.Position)
                end
            end)
            endConn = UserInputService.InputEnded:Connect(function(inp)
                if inp.UserInputType == Enum.UserInputType.MouseButton1 or inp.UserInputType == Enum.UserInputType.Touch then
                    isDragging = false
                    if moveConn then moveConn:Disconnect() end
                    if endConn then endConn:Disconnect() end
                    saveConfig()
                end
            end)
        end
    end)
end

CreateSettingsNavBtn("🎨 Color Settings", ColorFrame)
CreateSettingsNavBtn("📐 Advanced Settings", AdvancedFrame)

CreateToggle("Auto Activate To Work On Start", "AutoResetOnStart", function(state)
    DesyncResetButton.Visible = not state
    UpdateSpacerHeight()
end)

CreateToggle("Auto Giant Potion", "AutoBigPotion", nil)
CreateToggle("Auto Walk To Base (Might Be Broken)", "AutoWalk", nil)

createRainbowControl()
createRGBGroup("Background Color", "Background")
createRGBGroup("Outline Color", "Outline")

createSizeSlider("GUI Width", 200, 800, CurrentConfig.Size.Width, "X")
createSizeSlider("GUI Height", 200, 800, CurrentConfig.Size.Height, "Y")
-- ============================================================
-- 3D BASE INDICATORS
-- ============================================================
local leftStroke, leftGradient, rightStroke, rightGradient

task.wait(2)

local leftPos = Vector3.new(-356.18, 14.83, 6.40)
local leftBillboard = Instance.new("BillboardGui")
leftBillboard.Name = "LeftBaseIndicator"
leftBillboard.Size = UDim2.new(0, 180, 0, 60)
leftBillboard.StudsOffset = Vector3.new(0, 2, 0)
leftBillboard.AlwaysOnTop = true
leftBillboard.LightInfluence = 0
leftBillboard.Parent = workspace.Terrain

local leftFrame = Instance.new("Frame")
leftFrame.Size = UDim2.new(1, 0, 1, 0)
leftFrame.BackgroundColor3 = Color3.fromRGB(20, 10, 30)
leftFrame.BackgroundTransparency = 0.1
leftFrame.Parent = leftBillboard
Instance.new("UICorner", leftFrame).CornerRadius = UDim.new(0, 10)

leftStroke = Instance.new("UIStroke", leftFrame)
leftStroke.Thickness = 2.5
leftStroke.Color = Color3.fromRGB(180, 0, 255)

leftGradient = Instance.new("UIGradient")
leftGradient.Color = ColorSequence.new({
    ColorSequenceKeypoint.new(0, Color3.fromRGB(180, 0, 255)),
    ColorSequenceKeypoint.new(0.5, Color3.new(1,1,1)),
    ColorSequenceKeypoint.new(1, Color3.fromRGB(180, 0, 255))
})
leftGradient.Rotation = 45
leftGradient.Parent = leftStroke

local leftText = Instance.new("TextLabel")
leftText.Size = UDim2.new(1, 0, 0.6, 0)
leftText.Position = UDim2.new(0, 0, 0, 5)
leftText.BackgroundTransparency = 1
leftText.Text = "LEFT BASE"
leftText.Font = Enum.Font.GothamBlack
leftText.TextSize = 24
leftText.TextColor3 = Color3.fromRGB(255, 255, 255)
leftText.TextStrokeTransparency = 0.3
leftText.Parent = leftFrame

local leftCoords = Instance.new("TextLabel")
leftCoords.Size = UDim2.new(1, 0, 0.4, -5)
leftCoords.Position = UDim2.new(0, 0, 0.6, 0)
leftCoords.BackgroundTransparency = 1
leftCoords.Text = string.format("X: %.2f Y: %.2f Z: %.2f", leftPos.X, leftPos.Y, leftPos.Z)
leftCoords.Font = Enum.Font.GothamMedium
leftCoords.TextSize = 12
leftCoords.TextColor3 = Color3.fromRGB(200, 200, 255)
leftCoords.Parent = leftFrame

local leftPart = Instance.new("Part")
leftPart.Name = "LeftBasePosition"
leftPart.Size = Vector3.new(1, 1, 1)
leftPart.CFrame = CFrame.new(leftPos)
leftPart.Anchored = true
leftPart.CanCollide = false
leftPart.Transparency = 1
leftPart.Parent = workspace
leftBillboard.Adornee = leftPart

local rightPos = Vector3.new(-356.18, 14.83, 113.40)
local rightBillboard = Instance.new("BillboardGui")
rightBillboard.Name = "RightBaseIndicator"
rightBillboard.Size = UDim2.new(0, 180, 0, 60)
rightBillboard.StudsOffset = Vector3.new(0, 2, 0)
rightBillboard.AlwaysOnTop = true
rightBillboard.LightInfluence = 0
rightBillboard.Parent = workspace.Terrain

local rightFrame = Instance.new("Frame")
rightFrame.Size = UDim2.new(1, 0, 1, 0)
rightFrame.BackgroundColor3 = Color3.fromRGB(20, 10, 30)
rightFrame.BackgroundTransparency = 0.1
rightFrame.Parent = rightBillboard
Instance.new("UICorner", rightFrame).CornerRadius = UDim.new(0, 10)

rightStroke = Instance.new("UIStroke", rightFrame)
rightStroke.Thickness = 2.5
rightStroke.Color = Color3.fromRGB(180, 0, 255)

rightGradient = Instance.new("UIGradient")
rightGradient.Color = ColorSequence.new({
    ColorSequenceKeypoint.new(0, Color3.fromRGB(180, 0, 255)),
    ColorSequenceKeypoint.new(0.5, Color3.new(1,1,1)),
    ColorSequenceKeypoint.new(1, Color3.fromRGB(180, 0, 255))
})
rightGradient.Rotation = 45
rightGradient.Parent = rightStroke

local rightText = Instance.new("TextLabel")
rightText.Size = UDim2.new(1, 0, 0.6, 0)
rightText.Position = UDim2.new(0, 0, 0, 5)
rightText.BackgroundTransparency = 1
rightText.Text = "RIGHT BASE"
rightText.Font = Enum.Font.GothamBlack
rightText.TextSize = 24
rightText.TextColor3 = Color3.fromRGB(255, 255, 255)
rightText.TextStrokeTransparency = 0.3
rightText.Parent = rightFrame

local rightCoords = Instance.new("TextLabel")
rightCoords.Size = UDim2.new(1, 0, 0.4, -5)
rightCoords.Position = UDim2.new(0, 0, 0.6, 0)
rightCoords.BackgroundTransparency = 1
rightCoords.Text = string.format("X: %.2f Y: %.2f Z: %.2f", rightPos.X, rightPos.Y, rightPos.Z)
rightCoords.Font = Enum.Font.GothamMedium
rightCoords.TextSize = 12
rightCoords.TextColor3 = Color3.fromRGB(200, 200, 255)
rightCoords.Parent = rightFrame

local rightPart = Instance.new("Part")
rightPart.Name = "RightBasePosition"
rightPart.Size = Vector3.new(1, 1, 1)
rightPart.CFrame = CFrame.new(rightPos)
rightPart.Anchored = true
rightPart.CanCollide = false
rightPart.Transparency = 1
rightPart.Parent = workspace
rightBillboard.Adornee = rightPart

UpdateBaseIndicators = function()
    local outConfig = CurrentConfig.Colors.Outline
    local outCol = Color3.fromRGB(outConfig[1], outConfig[2], outConfig[3])
    local leftBB = workspace.Terrain:FindFirstChild("LeftBaseIndicator")
    local rightBB = workspace.Terrain:FindFirstChild("RightBaseIndicator")
    if leftBB then
        local lFrame = leftBB:FindFirstChild("Frame")
        if lFrame then
            local lStroke = lFrame:FindFirstChild("UIStroke")
            if lStroke then
                lStroke.Color = outCol
                local lGrad = lStroke:FindFirstChildOfClass("UIGradient")
                if lGrad then
                    lGrad.Color = ColorSequence.new({
                        ColorSequenceKeypoint.new(0, outCol),
                        ColorSequenceKeypoint.new(0.5, Color3.new(1,1,1)),
                        ColorSequenceKeypoint.new(1, outCol)
                    })
                end
            end
        end
    end
    if rightBB then
        local rFrame = rightBB:FindFirstChild("Frame")
        if rFrame then
            local rStroke = rFrame:FindFirstChild("UIStroke")
            if rStroke then
                rStroke.Color = outCol
                local rGrad = rStroke:FindFirstChildOfClass("UIGradient")
                if rGrad then
                    rGrad.Color = ColorSequence.new({
                        ColorSequenceKeypoint.new(0, outCol),
                        ColorSequenceKeypoint.new(0.5, Color3.new(1,1,1)),
                        ColorSequenceKeypoint.new(1, outCol)
                    })
                end
            end
        end
    end
end

task.spawn(function()
    local rot = 0
    while workspace do
        rot = rot + 1.5
        if leftGradient then leftGradient.Rotation = rot end
        if rightGradient then rightGradient.Rotation = rot end
        RunService.Heartbeat:Wait()
    end
end)

-- ============================================================
-- DRAGGING SYSTEM
-- ============================================================
local dragging, dragInput, dragStart, startPos

local function updateDrag(input)
    if dragging then
        local delta = input.Position - dragStart
        MainFrame.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
    end
end

Header.InputBegan:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
        dragging = true
        dragStart = input.Position
        startPos = MainFrame.Position
        input.Changed:Connect(function()
            if input.UserInputState == Enum.UserInputState.End then
                dragging = false
                saveConfig()
            end
        end)
    end
end)

Header.InputChanged:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch then
        dragInput = input
    end
end)

UserInputService.InputChanged:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch then
        if dragging then updateDrag(input) end
    end
end)

-- ============================================================
-- UI UPDATE FUNCTION
-- ============================================================
updateUI = function(enabled)
    autoStealEnabled = enabled
    if enabled then
        StealButton.Text = "START PROCESS..."
        StealButton.BackgroundColor3 = Color3.fromRGB(40, 80, 40)
        NearbyCountLabel.Text = tostring(#getAnimalsInRadius())
    else
        StealButton.Text = "TELEPORT"
        StealButton.BackgroundColor3 = Color3.fromRGB(30, 0, 50)
        NearbyCountLabel.Text = "0"
    end
end

task.spawn(function()
    ProgressContainer.Visible = true
    while task.wait() do
        if isStealing then
            ProgressFill.Size = UDim2.new(stealProgress, 0, 1, 0)
            if stealProgress < 0.33 then
                ProgressFill.BackgroundColor3 = Color3.fromRGB(255, 100, 100)
            elseif stealProgress < 0.66 then
                ProgressFill.BackgroundColor3 = Color3.fromRGB(255, 255, 100)
            else
                ProgressFill.BackgroundColor3 = Color3.fromRGB(100, 255, 100)
            end
        else
            ProgressFill.Size = UDim2.new(0, 0, 1, 0)
        end
    end
end)

task.spawn(function()
    while task.wait(0.5) do
        if not isStealing then
            NearbyCountLabel.Text = tostring(#getAnimalsInRadius())
        end
    end
end)

StealButton.MouseButton1Click:Connect(function()
    ClickSound:Play()
    if not autoStealEnabled and not isStealing then
        autoStealEnabled = true
        updateUI(true)
    end
end)

-- ============================================================
-- AUTO-STEAL MAIN LOOP
-- ============================================================
local stealConnection = nil

local function autoStealLoop()
    if stealConnection then stealConnection:Disconnect() end
    stealConnection = RunService.Heartbeat:Connect(function()
        if not autoStealEnabled or isStealing then return end
        local targetAnimal = get_nearest_animal_in_radius()
        if not targetAnimal or isMyBaseAnimal(targetAnimal.animalData) then return end
        local prompt = PromptMemoryCache[targetAnimal.animalData.uid]
        if not prompt or not prompt.Parent then
            prompt = findProximityPromptForAnimal(targetAnimal.animalData)
        end
        if prompt then attemptSteal(prompt, targetAnimal) end
    end)
end
-- ============================================================
-- TP CHECK ZONE WITH LINE AND WARNING
-- ============================================================
local tpZone = Instance.new("Part")
tpZone.Name = randomString(16)
tpZone.Size = Vector3.new(5, 7, 5)
tpZone.CFrame = CFrame.new(-370.50, -9.50 + 3.1, 58.80)
tpZone.Anchored = true
tpZone.CanCollide = false
tpZone.Transparency = 0.9
tpZone.Color = Color3.fromRGB(0, 255, 0)
tpZone.Material = Enum.Material.SmoothPlastic
tpZone.Parent = workspace

local selectionBox = Instance.new("SelectionBox")
selectionBox.Adornee = tpZone
selectionBox.Color3 = Color3.fromRGB(0, 255, 0)
selectionBox.LineThickness = 0.03
selectionBox.Transparency = 0.2
selectionBox.SurfaceTransparency = 1
selectionBox.Parent = tpZone

local linePart = Instance.new("Part")
linePart.Anchored = true
linePart.CanCollide = false
linePart.Material = Enum.Material.Neon
linePart.Color = Color3.fromRGB(0, 255, 0)
linePart.Transparency = 0.3
linePart.Parent = workspace

local currentLineStart = Vector3.new(0, 0, 0)
local currentLineEnd = Vector3.new(0, 0, 0)
local lineSmoothness = 0.3
local greenColor = Color3.fromRGB(0, 255, 0)
local redColor = Color3.fromRGB(255, 0, 0)
local lastWallState = nil

local function updateLinePart(startPosLine, endPosLine, color)
    currentLineStart = currentLineStart:Lerp(startPosLine, lineSmoothness)
    currentLineEnd = currentLineEnd:Lerp(endPosLine, lineSmoothness)
    local distance = (currentLineEnd - currentLineStart).Magnitude
    if distance < 0.1 then return end
    local midPoint = (currentLineStart + currentLineEnd) / 2
    linePart.Size = Vector3.new(0.15, 0.15, distance)
    linePart.CFrame = CFrame.lookAt(midPoint, currentLineEnd)
    linePart.Color = color
end

local function updateZoneColor(wallDetected)
    if lastWallState == wallDetected then return end
    lastWallState = wallDetected
    if wallDetected then
        tpZone.Color = redColor
        selectionBox.Color3 = redColor
    else
        tpZone.Color = greenColor
        selectionBox.Color3 = greenColor
    end
end

local warningGui = Instance.new("ScreenGui")
warningGui.ResetOnSpawn = false
pcall(function() warningGui.Parent = CoreGui end)

local warningFrame = Instance.new("Frame")
warningFrame.Size = UDim2.new(0, 450, 0, 50)
warningFrame.Position = UDim2.new(0.5, 0, 1, -150)
warningFrame.AnchorPoint = Vector2.new(0.5, 1)
warningFrame.BackgroundColor3 = Color3.fromRGB(200, 30, 30)
warningFrame.BackgroundTransparency = 0.15
warningFrame.Visible = false
warningFrame.Parent = warningGui
Instance.new("UICorner", warningFrame).CornerRadius = UDim.new(0, 12)

local warningStroke = Instance.new("UIStroke")
warningStroke.Color = Color3.fromRGB(255, 100, 100)
warningStroke.Thickness = 2
warningStroke.Parent = warningFrame

local warningText = Instance.new("TextLabel")
warningText.Size = UDim2.new(1, 0, 1, 0)
warningText.BackgroundTransparency = 1
warningText.Text = "⚠️ LINE ON WALL DETECTED - TP MIGHT NOT WORK ⚠️"
warningText.Font = Enum.Font.GothamBlack
warningText.TextSize = 16
warningText.TextColor3 = Color3.fromRGB(255, 255, 255)
warningText.TextStrokeTransparency = 0.5
warningText.Parent = warningFrame

local warningTween = nil
local isWarningVisible = false

local function checkWall()
    local character = LocalPlayer.Character
    if not character then return false end
    local hrp = character:FindFirstChild("HumanoidRootPart")
    if not hrp then return false end
    
    local playerPos = hrp.Position
    local zonePos = tpZone.Position
    local direction = (zonePos - playerPos)
    local distance = direction.Magnitude
    if distance < 1 then return false end
    direction = direction.Unit
    
    local ignoreList = {character, tpZone, linePart}
    local foldersToIgnore = {
        workspace:FindFirstChild("Animals"),
        workspace:FindFirstChild("Pets"),
        workspace:FindFirstChild("Effects"),
        workspace:FindFirstChild("NPCs"),
        workspace:FindFirstChild("Decorations"),
        workspace:FindFirstChild("Players"),
    }
    for _, folder in ipairs(foldersToIgnore) do
        if folder then table.insert(ignoreList, folder) end
    end
    for _, player in ipairs(Players:GetPlayers()) do
        if player.Character then table.insert(ignoreList, player.Character) end
    end
    
    local raycastParams = RaycastParams.new()
    raycastParams.FilterType = Enum.RaycastFilterType.Exclude
    raycastParams.FilterDescendantsInstances = ignoreList
    raycastParams.IgnoreWater = true
    
    local currentPos = playerPos
    local remainingDistance = distance
    local iteration = 0
    
    while remainingDistance > 0 and iteration < 20 do
        iteration = iteration + 1
        local raycastResult = workspace:Raycast(currentPos, direction * remainingDistance, raycastParams)
        if not raycastResult then return false end
        
        local hitPart = raycastResult.Instance
        if hitPart and hitPart.CanCollide == true then
            local isWall = true
            if hitPart.Size.Magnitude < 1 then isWall = false end
            if hitPart.Transparency >= 0.9 then isWall = false end
            
            local ignoredNames = {"HumanoidRootPart", "Head", "Torso", "Handle", "Effect", "Particle", "Beam", "Trail", "Hitbox", "Trigger", "Prompt", "Billboard", "GUI", "Attachment"}
            for _, name in ipairs(ignoredNames) do
                if string.find(string.lower(hitPart.Name), string.lower(name)) then isWall = false break end
            end
            
            if hitPart.Parent then
                local parentName = string.lower(hitPart.Parent.Name)
                if string.find(parentName, "animal") or string.find(parentName, "pet") or string.find(parentName, "npc") or string.find(parentName, "effect") or string.find(parentName, "player") then
                    isWall = false
                end
            end
            
            if isWall then return true end
        end
        
        local hitDistance = (raycastResult.Position - currentPos).Magnitude
        currentPos = raycastResult.Position + direction * 0.1
        remainingDistance = remainingDistance - hitDistance - 0.1
        table.insert(ignoreList, hitPart)
        raycastParams.FilterDescendantsInstances = ignoreList
    end
    return false
end

local function updateZoneAndLine()
    local character = LocalPlayer.Character
    if not character then 
        if isWarningVisible then isWarningVisible = false warningFrame.Visible = false end
        linePart.Transparency = 1
        return 
    end
    
    local hrp = character:FindFirstChild("HumanoidRootPart")
    if not hrp then return end
    
    updateLinePart(hrp.Position, tpZone.Position, linePart.Color)
    linePart.Transparency = 0.3
    
    local wallDetected = checkWall()
    if wallDetected then
        linePart.Color = Color3.fromRGB(255, 0, 0)
        updateZoneColor(true)
        if not isWarningVisible then
            isWarningVisible = true
            warningFrame.Visible = true
            warningFrame.Position = UDim2.new(0.5, 0, 1, -50)
            if warningTween then warningTween:Cancel() end
            warningTween = TweenService:Create(warningFrame, TweenInfo.new(0.4, Enum.EasingStyle.Back, Enum.EasingDirection.Out), {Position = UDim2.new(0.5, 0, 1, -150)})
            warningTween:Play()
        end
    else
        linePart.Color = Color3.fromRGB(0, 255, 0)
        updateZoneColor(false)
        if isWarningVisible then
            isWarningVisible = false
            if warningTween then warningTween:Cancel() end
            warningTween = TweenService:Create(warningFrame, TweenInfo.new(0.25, Enum.EasingStyle.Quad, Enum.EasingDirection.In), {Position = UDim2.new(0.5, 0, 1, -50)})
            warningTween:Play()
            task.delay(0.25, function() if not isWarningVisible then warningFrame.Visible = false end end)
        end
    end
end

RunService.RenderStepped:Connect(function() pcall(updateZoneAndLine) end)

-- ============================================================
-- STARTUP
-- ============================================================
MainFrame.Visible = true
StartupSound:Play()

if Blur then
    TweenService:Create(Blur, TweenInfo.new(1), {Size = 0}):Play()
    task.delay(1, function() Blur:Destroy() end)
end

TweenService:Create(MainFrame, TweenInfo.new(0.8, Enum.EasingStyle.Elastic, Enum.EasingDirection.Out), {
    Size = UDim2.new(0, CurrentConfig.Size.Width, 0, CurrentConfig.Size.Height)
}):Play()

UpdateTheme()
UpdateToggleVisuals()
initializePlotScanner()
autoStealLoop()

task.delay(1, function()
    bindToggleAction()
    if CurrentConfig.Settings.AutoResetOnStart then resetDesync() end
end)

task.delay(2, function() updateUI(false) end)
